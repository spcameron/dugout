#!/usr/bin/env bash
# shellcheck shell=bash
#
# scripts/audit

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/lib.sh"

trap '(( $? != 0 )) && printf "\n" && err "... audit failed."' EXIT

need_cmd go
need_cmd gofmt
need_cmd staticcheck
need_cmd govulncheck

# fmt_check fails if gofmt would make changes, and reports files
fmt_check() {
  info "Running gofmt check..."

  files="$(gofmt -l .)"
  if [[ -n "$files" ]]; then
    err "Refusing: gofmt required on:"
    printf '\n%s\n\n' "$files" >&2
    return 1
  fi

  ok "... complete."
  printf '\n'
}

# mod_tidy_check fails if tidy would make changes to go.mod/go.sum
mod_tidy_check() {
  info "Running tidy check..."

  tmp="${TMPDIR:-/tmp}/audit-go-mod-tidy.$$.diff"
  trap 'rm -f "$tmp"' RETURN

  set +e
  go mod tidy -diff >"$tmp" 2>&1
  status=$?
  set -e

  if [[ $status -ne 0 ]]; then
    err "go mod tidy failed (exit $status)"
    [[ -s "$tmp" ]] && printf '\n%s\n\n' "$(<"$tmp")" >&2
    return 1
  fi

  if [[ -s "$tmp" ]]; then
    err "Refusing: go.mod/go.sum are not tidy."
    printf '\n%s\n\n' "$(<"$tmp")" >&2
    warn "Run 'go mod tidy'"
    return 1
  fi

  ok "... complete."
  printf '\n'
}

# mod_verify runs go mod verify, accepts tool error outputs
mod_verify() {
  info "Running go mod verify..."

  go mod verify

  ok "... complete."
  printf '\n'
}

# vet runs go vet, accepts tool error outputs
vet() {
  info "Running go vet..."

  go vet ./...

  ok "... complete."
  printf '\n'
}

# staticcheck_check fails if staticcheck reports issues
staticcheck_check() {
  info "Running staticcheck..."

  tmp="${TMPDIR:-/tmp}/audit-staticcheck.$$.out"
  trap 'rm -f "$tmp"' RETURN

  set +e
  staticcheck -checks=all,-ST1000,-U1000 ./... >"$tmp" 2>&1
  status=$?
  set -e

  if [[ $status -ne 0 ]]; then
    err "Refusing: staticcheck reported issues (exit $status)"
    if [[ -s "$tmp" ]]; then
      printf '\n%s\n\n' "$(<"$tmp")" >&2
      warn "Review findings and address reported issues"
    fi
    return 1
  fi

  ok "... complete."
  printf '\n'
}

# vulncheck_check fails if vulncheck reports vulnerabilities
vulncheck_check() {
  info "Running vulncheck..."

  tmp="${TMPDIR:-/tmp}/audit-vulncheck.$$.out"
  trap 'rm -f "$tmp"' RETURN

  set +e
  govulncheck ./... >"$tmp" 2>&1
  status=$?
  set -e

  if [[ $status -ne 0 ]]; then
    err "Refusing: govulncheck reported vulnerabilities (exit $status)"
    if [[ -s "$tmp" ]]; then
      printf '\n%s\n\n' "$(<"$tmp")" >&2
      warn "Review vulnerabilities; update dependencies or document mitigations"
    fi
    return 1
  fi

  ok "... complete."
  printf '\n'
}

main() {
  info "Running audit..."
  printf '\n'
  fmt_check
  mod_tidy_check
  mod_verify
  vet
  staticcheck_check
  vulncheck_check
  ok "... audit complete."
  # printf '\n'
}

main "$@"
